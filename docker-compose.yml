version: '3.8'

services:
  # Database Services
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: evdms
      POSTGRES_USER: evdms_user
      POSTGRES_PASSWORD: evdms_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/postgres:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    networks:
      - evdms-network

  mongo:
    image: mongo:7.0
    environment:
      MONGO_INITDB_ROOT_USERNAME: evdms_user
      MONGO_INITDB_ROOT_PASSWORD: evdms_password
      MONGO_INITDB_DATABASE: evdms
    volumes:
      - mongo_data:/data/db
      - ./database/mongo:/docker-entrypoint-initdb.d
    ports:
      - "27017:27017"
    networks:
      - evdms-network

  # Message Queue
  rabbitmq:
    image: rabbitmq:3-management-alpine
    environment:
      RABBITMQ_DEFAULT_USER: evdms_user
      RABBITMQ_DEFAULT_PASS: evdms_password
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - evdms-network

  # Redis for caching
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - evdms-network

  # Microservices
  auth-service:
    build: ./auth-service
    ports:
      - "${AUTH_SERVICE_PORT:-3001}:3001"
    environment:
      # Profile: 'docker' (local DB) or 'supabase' (cloud DB)
      SPRING_PROFILES_ACTIVE: ${AUTH_PROFILE:-docker}
      SERVER_PORT: 3001
      
      # Redis
      SPRING_REDIS_HOST: ${REDIS_HOST:-redis}
      SPRING_REDIS_PORT: ${REDIS_PORT:-6379}
      
      # JWT
      SECURITY_JWT_SECRET: ${JWT_SECRET}
      SECURITY_JWT_ACCESS_TOKEN_EXPIRY: ${JWT_ACCESS_TOKEN_EXPIRY:-900000}
      SECURITY_JWT_REFRESH_TOKEN_EXPIRY: ${JWT_REFRESH_TOKEN_EXPIRY:-604800000}
    depends_on:
      - postgres
      - redis
    networks:
      - evdms-network
    restart: unless-stopped

  dealer-service:
    build: ./services/dealer-service
    ports:
      - "3002:3002"
    environment:
      NODE_ENV: development
      PORT: 3002
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: evdms
      DB_USER: evdms_user
      DB_PASSWORD: evdms_password
      REDIS_URL: redis://redis:6379
      RABBITMQ_URL: amqp://evdms_user:evdms_password@rabbitmq:5672
      AUTH_SERVICE_URL: http://auth-service:3001
    depends_on:
      - postgres
      - redis
      - rabbitmq
      - auth-service
    networks:
      - evdms-network

  customer-service:
    build: ./customer-service
    ports:
      - "${CUSTOMER_SERVICE_PORT:-3003}:3003"
    environment:
      # Profile: 'docker' (local DB) or 'supabase' (cloud DB)
      SPRING_PROFILES_ACTIVE: ${CUSTOMER_PROFILE:-docker}
      SERVER_PORT: 3003
      
      # RabbitMQ
      SPRING_RABBITMQ_HOST: ${RABBITMQ_HOST:-rabbitmq}
      SPRING_RABBITMQ_PORT: ${RABBITMQ_PORT:-5672}
      SPRING_RABBITMQ_USERNAME: ${RABBITMQ_USER:-evdms_user}
      SPRING_RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:-evdms_password}
      
      # JWT
      SECURITY_JWT_SECRET: ${JWT_SECRET}
    depends_on:
      - postgres
      - rabbitmq
    networks:
      - evdms-network
    restart: unless-stopped

  manufacturer-service:
    build: ./services/manufacturer-service
    ports:
      - "3004:3004"
    environment:
      NODE_ENV: development
      PORT: 3004
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: evdms
      DB_USER: evdms_user
      DB_PASSWORD: evdms_password
      REDIS_URL: redis://redis:6379
      RABBITMQ_URL: amqp://evdms_user:evdms_password@rabbitmq:5672
      AUTH_SERVICE_URL: http://auth-service:3001
    depends_on:
      - postgres
      - redis
      - rabbitmq
      - auth-service
    networks:
      - evdms-network

  report-service:
    build: ./services/report-service
    ports:
      - "3005:3005"
    environment:
      NODE_ENV: development
      PORT: 3005
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: evdms
      DB_USER: evdms_user
      DB_PASSWORD: evdms_password
      MONGO_URL: mongodb://evdms_user:evdms_password@mongo:27017/evdms
      REDIS_URL: redis://redis:6379
      AUTH_SERVICE_URL: http://auth-service:3001
    depends_on:
      - postgres
      - mongo
      - redis
      - auth-service
    networks:
      - evdms-network

  notification-service:
    build: ./services/notification-service
    ports:
      - "3006:3006"
    environment:
      NODE_ENV: development
      PORT: 3006
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: evdms
      DB_USER: evdms_user
      DB_PASSWORD: evdms_password
      RABBITMQ_URL: amqp://evdms_user:evdms_password@rabbitmq:5672
      REDIS_URL: redis://redis:6379
      SMTP_HOST: smtp.gmail.com
      SMTP_PORT: 587
      SMTP_USER: your-email@gmail.com
      SMTP_PASS: your-app-password
    depends_on:
      - postgres
      - rabbitmq
      - redis
    networks:
      - evdms-network

  # API Gateway
  api-gateway:
    build: ./gateway
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: development
      PORT: 3000
      AUTH_SERVICE_URL: http://auth-service:3001
      DEALER_SERVICE_URL: http://dealer-service:3002
      CUSTOMER_SERVICE_URL: http://customer-service:3003
      MANUFACTURER_SERVICE_URL: http://manufacturer-service:3004
      REPORT_SERVICE_URL: http://report-service:3005
      NOTIFICATION_SERVICE_URL: http://notification-service:3006
      REDIS_URL: redis://redis:6379
    depends_on:
      - auth-service
      - dealer-service
      - customer-service
      - manufacturer-service
      - report-service
      - notification-service
    networks:
      - evdms-network

  # Frontend Applications
  dealer-dashboard:
    build: ./frontend/dealer-dashboard
    ports:
      - "3010:3000"
    environment:
      REACT_APP_API_URL: http://localhost:3000/api
      REACT_APP_WEBSOCKET_URL: ws://localhost:3000
    depends_on:
      - api-gateway
    networks:
      - evdms-network

  manufacturer-dashboard:
    build: ./frontend/manufacturer-dashboard
    ports:
      - "3011:3000"
    environment:
      REACT_APP_API_URL: http://localhost:3000/api
      REACT_APP_WEBSOCKET_URL: ws://localhost:3000
    depends_on:
      - api-gateway
    networks:
      - evdms-network

  admin-panel:
    build: ./frontend/admin-panel
    ports:
      - "3012:3000"
    environment:
      REACT_APP_API_URL: http://localhost:3000/api
      REACT_APP_WEBSOCKET_URL: ws://localhost:3000
    depends_on:
      - api-gateway
    networks:
      - evdms-network

volumes:
  postgres_data:
  mongo_data:
  rabbitmq_data:
  redis_data:


networks:
  evdms-network:
    driver: bridge
